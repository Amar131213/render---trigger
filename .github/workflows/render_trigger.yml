name: Trigger Render Daily

on:
  workflow_dispatch:
  schedule:
    - cron: '30 11 * * 1-5'  # ‡§∏‡•ã‡§Æ‡§µ‡§æ‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§ï‡•ç‡§∞‡§µ‡§æ‡§∞ ‡§∂‡§æ‡§Æ 5 ‡§¨‡§ú‡•á IST

jobs:
  trigger_render:
    runs-on: ubuntu-latest
    steps:
      - name: ‚è≥ Wait for 200 OK from Render (Max 5 min)
        run: |
          echo "üöÄ Triggering Render and waiting until 200 OK..."

          start_time=$(date +%s)
          timeout=$((5 * 60))  # 5 minutes in seconds

          while true; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://screener-scraper.onrender.com/run)

            if [ "$response" -eq 200 ]; then
              echo "‚úÖ Success! Got 200 OK"
              break
            fi

            now=$(date +%s)
            elapsed=$((now - start_time))

            if [ "$elapsed" -ge "$timeout" ]; then
              echo "‚ùå Timeout! Did not receive 200 OK in 5 minutes."
              exit 1
            fi

            echo "üîÅ Got $response. Retrying in 5s... (Elapsed: ${elapsed}s)"
            sleep 5
          done
