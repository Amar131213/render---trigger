name: Trigger Render Scraper

on:
  schedule:
    - cron: '30 11 * * 1-5'  # ‡§π‡§∞ ‡§∏‡•ã‡§Æ‡§µ‡§æ‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§ï‡•ç‡§∞‡§µ‡§æ‡§∞ ‡§∂‡§æ‡§Æ 5:00 IST
  workflow_dispatch:

jobs:
  trigger_render:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render Webhook with Retry & Wait
        run: |
          echo "üöÄ Triggering Render /run endpoint with retry and long wait..."

          MAX_RETRIES=3
          RETRY_DELAY=45  # seconds
          COUNT=0
          SUCCESS=false

          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "üîÅ Attempt $((COUNT+1))..."

            # Curl with long timeout, silent & fail-safe output
            RESPONSE=$(curl --connect-timeout 30 --max-time 120 \
              -s -w "\n\n‚è±Ô∏è Time Taken: %{time_total}s\n" \
              https://screener-scraper.onrender.com/run)

            echo "$RESPONSE"

            # Check expected response
            echo "$RESPONSE" | grep -q "üü¢ Scraper started in background." && {
              echo "‚úÖ Render scraper started successfully."
              SUCCESS=true
              break
            }

            echo "‚ùå Failed attempt $((COUNT+1)). Retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
            COUNT=$((COUNT+1))
          done

          # Final check
          if [ "$SUCCESS" = false ]; then
            echo "‚ùå All attempts failed. Render did not respond with expected status."
            exit 1
          fi
