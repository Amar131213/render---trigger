name: Trigger Render Daily

on:
  schedule:
    - cron: '30 11 * * 1-5'  # à¤¸à¥‹à¤®à¤µà¤¾à¤° à¤¸à¥‡ à¤¶à¥à¤•à¥à¤°à¤µà¤¾à¤°, IST 5:00 PM
  workflow_dispatch:

jobs:
  trigger_render:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq (JSON parser)
        run: sudo apt-get install -y jq

      - name: Trigger Render Webhook and wait for correct response
        run: |
          echo "ğŸ”ƒ Calling /run endpoint..."
          response=$(curl -s "https://screener-scraper.onrender.com/run")

          echo "ğŸ“¦ Raw response: $response"

          # Check if response is valid JSON
          if echo "$response" | jq empty > /dev/null 2>&1; then
            status=$(echo "$response" | jq -r '.status // empty')
            echo "ğŸ§ª Extracted status: $status"

            if [[ "$status" == "ğŸŸ¢ Scraper started in background." || "$status" == "âš ï¸ Already running" ]]; then
              echo "âœ… Scraper started or already running"
            else
              echo "âŒ Unexpected status: $status"
              exit 1
            fi
          else
            echo "âŒ Not a valid JSON response. Possibly rate-limited or Render error."
            exit 1
          fi
